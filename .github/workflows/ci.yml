name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install make + wget
        run: |
          sudo apt-get update
          sudo apt-get install -y make wget

      - name: Start backend + migrate (make run)
        working-directory: bps-backend
        run: make run

      - name: Debug compose state
        run: |
          docker compose -f bps-backend/http-compose.yml ps
          docker compose -f bps-backend/http-compose.yml logs --tail=200

      - name: Wait for http container healthy
        run: |
          set -e
          docker compose -f bps-backend/http-compose.yml ps

          cid="$(docker compose -f bps-backend/http-compose.yml ps -q http)"
          echo "http container id: $cid"

          if [ -z "$cid" ]; then
            echo "http container not found (it likely crashed on startup)"
            docker compose -f bps-backend/http-compose.yml logs --tail=400 http || true
            exit 1
          fi

          for i in $(seq 1 90); do
            status="$(docker inspect -f '{{.State.Health.Status}}' "$cid" 2>/dev/null || true)"
            echo "health=$status"
            if [ "$status" = "healthy" ]; then
              echo "Backend is healthy"
              exit 0
            fi
            sleep 2
          done

          echo "http did not become healthy"
          docker logs --tail=400 "$cid" || true
          exit 1

      - name: Install and run tests
        working-directory: tests
        env:
          BACKEND_URL: http://localhost:3000
        run: |
          npm install
          npm run test

      - name: Shutdown (always)
        if: always()
        run: |
          docker compose -f bps-backend/http-compose.yml logs --tail=200 || true
          docker compose -f bps-backend/http-compose.yml down -v
